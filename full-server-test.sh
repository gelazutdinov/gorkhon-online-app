#!/bin/bash

echo "üö® –ü–û–õ–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ï–†–í–ï–†–ê - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û!"
echo "================================================="

# –£–±–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3001
echo "üî™ –®–∞–≥ 1: –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 3001..."
lsof -ti:3001 | xargs kill -9 2>/dev/null || echo "–ü–æ—Ä—Ç 3001 —É–∂–µ —Å–≤–æ–±–æ–¥–µ–Ω"

sleep 1

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
echo ""
echo "üöÄ –®–∞–≥ 2: –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä..."
cd server && node working-server.js &
SERVER_PID=$!
echo "–°–µ—Ä–≤–µ—Ä PID: $SERVER_PID"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo ""
echo "‚è≥ –®–∞–≥ 3: –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (3 —Å–µ–∫—É–Ω–¥—ã)..."
sleep 3

# –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä
echo ""
echo "üß™ –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä..."
node test-working-server.js

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ curl —Ç–µ—Å—Ç—ã
echo ""
echo "üåê –®–∞–≥ 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ curl —Ç–µ—Å—Ç—ã..."
echo "Health check:"
curl -s http://localhost:3001/api/health | head -c 200
echo ""

echo ""
echo "Login test:"
curl -s -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"smm@gelazutdinov.ru","password":"admin123"}' | head -c 200
echo ""

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
echo ""
echo "üõë –®–∞–≥ 6: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä..."
kill $SERVER_PID 2>/dev/null

sleep 1

echo ""
echo "================================================="
echo "‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo ""
echo "–ö–û–ú–ê–ù–î–´ –î–õ–Ø –ó–ê–ü–£–°–ö–ê –°–ï–†–í–ï–†–ê:"
echo "1. –ü—Ä–æ—Å—Ç–æ–π —Ä–∞–±–æ—á–∏–π —Å–µ—Ä–≤–µ—Ä: ./start-working-server.sh"
echo "2. –ò–ª–∏ –≤—Ä—É—á–Ω—É—é: cd server && node working-server.js"
echo ""
echo "–ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–´:"
echo "curl http://localhost:3001/api/health"