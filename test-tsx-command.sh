#!/bin/bash

echo "üî• –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã: cd server && tsx src/app.ts"
echo "=================================================="
echo

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ server
if [ ! -d "server" ]; then
    echo "‚ùå –ü–∞–ø–∫–∞ 'server' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi
echo "‚úÖ –ü–∞–ø–∫–∞ 'server' –Ω–∞–π–¥–µ–Ω–∞"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É server
cd server
echo "üìÅ –ü–µ—Ä–µ—à–ª–∏ –≤: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ app.ts
if [ ! -f "src/app.ts" ]; then
    echo "‚ùå –§–∞–π–ª 'src/app.ts' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi
echo "‚úÖ –§–∞–π–ª 'src/app.ts' –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ tsx
echo
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å tsx..."
if command -v npx >/dev/null 2>&1; then
    echo "‚úÖ npx –¥–æ—Å—Ç—É–ø–µ–Ω"
    
    if npx tsx --version >/dev/null 2>&1; then
        TSX_VERSION=$(npx tsx --version 2>/dev/null)
        echo "‚úÖ tsx –¥–æ—Å—Ç—É–ø–µ–Ω, –≤–µ—Ä—Å–∏—è: $TSX_VERSION"
    else
        echo "‚ùå tsx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ npx"
        exit 1
    fi
else
    echo "‚ùå npx –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    exit 1
fi

echo
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É: tsx src/app.ts"
echo "=================================="

# –ó–∞–ø—É—Å–∫–∞–µ–º tsx —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
timeout 8s npx tsx src/app.ts &
TSX_PID=$!

echo "üÜî PID –ø—Ä–æ—Ü–µ—Å—Å–∞ tsx: $TSX_PID"
echo "‚è∞ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (8 —Å–µ–∫—É–Ω–¥)..."

# –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞
wait $TSX_PID 2>/dev/null
EXIT_CODE=$?

echo
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢:"
echo "============"

if [ $EXIT_CODE -eq 124 ]; then
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–ª –∏ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É"
    echo "üéØ –£–°–ü–ï–•: –ö–æ–º–∞–Ω–¥–∞ tsx src/app.ts —Ä–∞–±–æ—Ç–∞–µ—Ç!"
elif [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    echo "üéØ –£–°–ü–ï–•: –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫"
else
    echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π (–∫–æ–¥: $EXIT_CODE)"
    echo "üéØ –û–®–ò–ë–ö–ê: –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∫–æ–º–∞–Ω–¥—ã"
fi

echo
echo "üèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
echo "========================"

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ..

exit $EXIT_CODE