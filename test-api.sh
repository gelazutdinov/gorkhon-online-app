#!/bin/bash

echo "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints"
echo "============================="
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Node.js
if ! command -v node &> /dev/null; then
    echo "‚ùå Node.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "‚úÖ Node.js –Ω–∞–π–¥–µ–Ω: $(node --version)"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ —Å–µ—Ä–≤–µ—Ä
if curl -s http://localhost:3001/api/health > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –°–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001"
    echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints..."
    echo ""
    node simple-test.js
    exit 0
fi

echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
node test-simple-server.js &
SERVER_PID=$!

echo "üì° –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å PID: $SERVER_PID"
echo "‚è≥ –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏..."
sleep 3

echo ""
echo "üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º endpoints..."
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
node simple-test.js

echo ""
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."

# –£–±–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä
kill $SERVER_PID 2>/dev/null

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
sleep 1

echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"