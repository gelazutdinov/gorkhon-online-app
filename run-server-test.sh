#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ TypeScript —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ tsx..."
echo "==========================================="

# –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
ORIGINAL_DIR=$(pwd)

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é server
echo "üìÅ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É server..."
cd server || {
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É server"
    exit 1
}

echo "‚úÖ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ app.ts
if [ ! -f "src/app.ts" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª src/app.ts –Ω–µ –Ω–∞–π–¥–µ–Ω"
    cd "$ORIGINAL_DIR"
    exit 1
fi

echo "‚úÖ –§–∞–π–ª src/app.ts –Ω–∞–π–¥–µ–Ω"

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É tsx src/app.ts
echo ""
echo "üî• –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É: tsx src/app.ts"
echo "==========================================="

# –ó–∞–ø—É—Å–∫ —Å –≤—ã–≤–æ–¥–æ–º –≤—Å–µ—Ö –ª–æ–≥–æ–≤
npx tsx src/app.ts &

# –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞
SERVER_PID=$!

echo "üÜî PID —Å–µ—Ä–≤–µ—Ä–∞: $SERVER_PID"

# –ñ–¥–µ–º 8 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (8 —Å–µ–∫—É–Ω–¥)..."
sleep 8

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
if kill -0 $SERVER_PID 2>/dev/null; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º health endpoint
    echo ""
    echo "üè• –¢–µ—Å—Ç–∏—Ä—É–µ–º health endpoint..."
    if command -v curl >/dev/null 2>&1; then
        curl -s "http://localhost:3001/api/health" | head -c 500
        echo ""
    else
        echo "‚ö†Ô∏è curl –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç endpoint"
    fi
    
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."
    kill $SERVER_PID
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    wait $SERVER_PID 2>/dev/null
    
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "üéØ –†–ï–ó–£–õ–¨–¢–ê–¢: –£–°–ü–ï–• - –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!"
    
else
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
    echo ""
    echo "üéØ –†–ï–ó–£–õ–¨–¢–ê–¢: –û–®–ò–ë–ö–ê - –°–µ—Ä–≤–µ—Ä –Ω–µ —Å–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è!"
    
    cd "$ORIGINAL_DIR"
    exit 1
fi

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd "$ORIGINAL_DIR"

echo ""
echo "==========================================="
echo "üèÅ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
echo "==========================================="