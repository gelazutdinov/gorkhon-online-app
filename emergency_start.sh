#!/bin/bash

# –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–í–ê–†–ò–ô–ù–´–ô –ó–ê–ü–£–°–ö DEV-–°–ï–†–í–ï–†–ê

echo "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é dev-—Å–µ—Ä–≤–µ—Ä!"

# 1. –£–ë–ò–í–ê–ï–ú –í–°–ï –ø—Ä–æ—Ü–µ—Å—Å—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
echo "1. –£–±–∏–≤–∞—é –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
killall -9 node 2>/dev/null || true
killall -9 vite 2>/dev/null || true
pkill -f "npm.*dev" 2>/dev/null || true
pkill -f "bun.*dev" 2>/dev/null || true
fuser -k 5173/tcp 2>/dev/null || true

# 2. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç 5173
echo "2. –û—Å–≤–æ–±–æ–∂–¥–∞—é –ø–æ—Ä—Ç 5173..."
lsof -ti:5173 | xargs kill -9 2>/dev/null || true

# 3. –û—á–∏—â–∞–µ–º –∫—ç—à
echo "3. –û—á–∏—â–∞—é –∫—ç—à–∏..."
rm -rf node_modules/.vite 2>/dev/null || true
bun cache clear 2>/dev/null || true

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ dev —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo "4. –ü—Ä–æ–≤–µ—Ä—è—é package.json..."
if ! grep -q "\"dev\":" package.json; then
    echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ dev –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ package.json!"
    exit 1
fi

# 5. –ó–ê–ü–£–°–ö–ê–ï–ú —Å–µ—Ä–≤–µ—Ä
echo "5. üöÄ –ó–ê–ü–£–°–ö–ê–Æ DEV-–°–ï–†–í–ï–†..."
echo "–ó–∞–ø—É—Å–∫: bun run dev"
echo "URL: http://localhost:5173"
echo "–î–∞—Ç–∞ –∑–∞–ø—É—Å–∫–∞: $(date)"

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ PID
nohup bun run dev > vite-dev.log 2>&1 &
SERVER_PID=$!

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å PID: $SERVER_PID"
echo "üìù –õ–æ–≥–∏: vite-dev.log"

# –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞
sleep 3

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
echo "6. üîç –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞..."
if curl -s -I http://localhost:5173 | grep -q "200\|404"; then
    echo "‚úÖ –†–ê–ë–û–¢–ê–ï–¢! –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:5173"
    echo "üéâ DEV-–°–ï–†–í–ï–† –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù!"
    exit 0
else
    echo "‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢! –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "–ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏: cat vite-dev.log"
    exit 1
fi